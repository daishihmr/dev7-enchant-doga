<html>
<head>
<meta charset=UTF-8>
<title>WALKING!</title>
<script type="text/javascript" src="gl-matrix.js"></script>
<script type="text/javascript" src="enchant.min.js"></script>
<script type="text/javascript" src="gl.enchant.js"></script>
<script type="text/javascript" src="primitive.gl.enchant.js"></script>
<script type="text/javascript" src="../dogencha.enchant.js"></script>
<script type="text/javascript">
enchant();
window.onload = function() {
    var menu = document.getElementById("menu");
    var game = new Core(512, 512);

    // JSONモデルデータ読み込み
    game.preload("walker_a.l2c.json", "square.l2c.json", "bird.l2c.json");

    game.onload = function() {
        var scene = new Scene3D();

        // 床を表示
        var floor = new Floor();
        scene.addChild(floor);

        // キャラクターデータ
        var dataTable = [
            {
                name: "ロボ",
                entity: game.assets["square.l2c.json"],
                standPose: "stand",
                walkingMotion: [ "walk1", "walk2", "walk3", "walk4" ],
            },
            {
                name: "ウォーカー",
                entity: game.assets["walker_a.l2c.json"],
                standPose: "_initialPose",
                walkingMotion: [ "Walk1", "Walk2", "Walk3", "Walk4" ],
            },
            {
                name: "とり",
                entity: game.assets["bird.l2c.json"],
                standPose: "Stop",
                walkingMotion: [ "Fly1", "Fly2", "Fly3", "Fly4" ],
            },
        ];

        // 初期設定
        dataTable.forEach(function(data) {
            // メニューにアイテム追加
            var option = document.createElement("option");
            option.textContent = data.name;
            menu.appendChild(option);

            // 歩いてるフラグ
            data.walking = false;

            // ポーズを立ちポーズにセット
            data.entity.setPose(data.standPose);

            scene.addChild(data.entity);
        });
        dataTable[2].entity.y = 0.5;

        // 操作する対象
        var controlTarget = 0;
        // メニュー変更時に操作対象を変更する
        menu.onchange = function() {
            controlTarget = this.selectedIndex;
        };

        // カメラ位置
        var camera = scene.getCamera();
        camera.x = 0;
        camera.y = 5;
        camera.z = -5;

        game.on("enterframe", function() {
            var data = dataTable[controlTarget];
            var entity = data.entity;

            // キー入力
            var kb = game.input;
            if (kb.up)    entity.forward(+0.1); // 前進
            if (kb.down)  entity.forward(-0.1); // 後退
            if (kb.left)  entity.rotateYaw(+0.1); // 左旋回
            if (kb.right) entity.rotateYaw(-0.1); // 右旋回

            // 直前まで歩いていたか
            var beforeWalking = data.walking;

            // いずれかのカーソルキー入力がある場合は歩いてるフラグオン
            data.walking = kb.up || kb.down || kb.left || kb.right;

            if (!beforeWalking && data.walking) {

                // 直前までは歩いていない & 今歩いている => 歩き出した
                console.log("start");
                entity.mtl.clear();
                for (var i = 0, end = data.walkingMotion.length; i < end; i++) {
                    entity.mtl.motion(data.walkingMotion[i], 5);
                }
                entity.mtl.loop();

            } else if (beforeWalking && !data.walking) {

                // 直前まで歩いた & 今歩いていない => 立ち止まった
                console.log("stop");
                entity.mtl.clear().motion(data.standPose, 5);

            }

            // カメラを向ける
            camera.lookAt(entity);
            camera.centerY = entity.y + 0.5;
        });
    };
    game.start();
};

// 床クラス
var Floor = Class.create(Sprite3D, {
    initialize: function() {
        Sprite3D.call(this);
        var black = new Cube();
        black.mesh.setBaseColor([ 0.2, 0.2, 0.2, 1.0 ]);
        var white = new Cube();
        white.mesh.setBaseColor([ 0.8, 0.8, 0.8, 1.0 ]);

        var tiles = [ black, white ];

        for (var i = 0; i < 27; i++) {
            for (var j = 0; j < 27; j++) {
                var tile = tiles[ (i*9+j) % 2 ].clone();
                tile.x = i - (27-1)/2;
                tile.z = j - (27-1)/2;
                this.addChild(tile);
            }
        }

        this.y = -0.5;
    }
});
</script>
</head>
<body>
    DATA: <select id="menu"></select>
    <div id="enchant-stage"></div>
</body>
</html>